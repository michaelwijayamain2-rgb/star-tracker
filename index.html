<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Star Tracker: Cloud Sync</title>
    <link rel="apple-touch-icon" href="https://img.icons8.com/emoji/96/star-emoji.png">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --primary: #FFD700; --success: #4CAF50; --danger: #FF5252; --info: #2196F3; --bg: #F0F8FF; }
        body { font-family: 'Quicksand', sans-serif; background-color: var(--bg); margin: 0; padding: 10px; text-align: center; }
        #monthlyAlertBanner { display: none; background: var(--info); color: white; padding: 15px; position: fixed; top: 0; left: 0; width: 100%; z-index: 2000; font-weight: bold; }
        .kid-header { background: white; padding: 15px; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 4px 0 #ddd; display: flex; align-items: center; justify-content: space-around; }
        .dashboard { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 10px; border-radius: 15px; box-shadow: 0 4px 0 #ddd; min-width: 120px; }
        .stat-val { font-size: 1.6rem; color: var(--primary); display: block; font-weight: bold; }
        .action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; max-width: 800px; margin: 0 auto; }
        .action-card { background: white; padding: 20px; border-radius: 20px; border: 3px solid #eee; cursor: pointer; box-shadow: 0 4px 0 #eee; }
        .particle { position: fixed; pointer-events: none; z-index: 100; font-size: 2.5rem; animation: flyUp 1s forwards; }
        @keyframes flyUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-100px); opacity: 0; } }
    </style>
</head>
<body>

    <div id="monthlyAlertBanner">
        ðŸ“… A new month has started! Points have been reset.
        <button onclick="document.getElementById('monthlyAlertBanner').style.display='none'">Got it!</button>
    </div>

    <div class="kid-header">
        <select id="activeKidSelect" onchange="changeKid()"></select>
    </div>

    <div class="dashboard">
        <div class="stat-card"><span id="totalPoints" class="stat-val">Loading...</span><span style="font-size:0.6rem">TOTAL STAR POINTS</span></div>
    </div>

    <div id="actionGrid" class="action-grid"></div>

    <script>
        // REPLACE THESE WITH YOUR ACTUAL SUPABASE KEYS
        const SUPABASE_URL = 'https://kyljmfooeekqqcgbiowc.supabase.co';
        const SUPABASE_KEY = process.env.SUPABASE_KEY;
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let activeKid = "Child 1";
        let chores = [
            { id: 1, text: "Brush Teeth", val: 5, icon: "ðŸ¦·" },
            { id: 2, text: "Clean Room", val: 10, icon: "ðŸ§¹" }
        ];

        async function init() {
            await fetchKids();
            render();
            
            // MAGIC: Listen for live changes from other phones
            supabase.channel('custom-all-channel')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'star_tracker' }, (payload) => {
                if(payload.new.kid_name === activeKid) {
                    document.getElementById('totalPoints').innerText = payload.new.stars;
                }
            })
            .subscribe();
        }

        async function fetchKids() {
            const { data } = await supabase.from('star_tracker').select('*');
            const sel = document.getElementById('activeKidSelect');
            sel.innerHTML = '';
            data.forEach(k => {
                sel.innerHTML += `<option value="${k.kid_name}">${k.kid_name}</option>`;
            });
            updateDisplay(data.find(k => k.kid_name === activeKid));
        }

        function updateDisplay(kidData) {
            if (kidData) document.getElementById('totalPoints').innerText = kidData.stars;
        }

        async function handleAction(val, e) {
            const currentStars = parseInt(document.getElementById('totalPoints').innerText);
            const newStars = currentStars + val;

            // Save to Cloud
            await supabase.from('star_tracker')
                .update({ stars: newStars })
                .eq('kid_name', activeKid);

            createParticle(e.clientX, e.clientY, "â­");
        }

        function render() {
            const grid = document.getElementById('actionGrid');
            grid.innerHTML = '';
            chores.forEach(item => {
                grid.innerHTML += `<div class="action-card" onclick="handleAction(${item.val}, event)">
                    <span>${item.icon}</span><br><b>${item.text}</b><br>+${item.val}
                </div>`;
            });
        }

        function changeKid() {
            activeKid = document.getElementById('activeKidSelect').value;
            fetchKids();
        }

        function createParticle(x,y,c){const p=document.createElement('div');p.className='particle';p.style.left=x+'px';p.style.top=y+'px';p.innerText=c;document.body.appendChild(p);setTimeout(()=>p.remove(),1000);}

        window.onload = init;
    </script>
</body>
</html>
